# 将part1和part 2内容合并
import os
import requests
import time

requests.adapters.DEFAULT_RETRIES = 5
url = 'https://www.virustotal.com/vtapi/v2/file/report'
params = {'apikey': 'b1571259fa877a755620a3cacb5833622fcdd8695a81be93306a747c408795e7',
          'resource': '<resource>'}

def get_label(md5):
    params['resource'] = md5
    response = requests.get(url, params=params)
    while response.status_code != 200:
        print('未获取信息,10s后重试')
        time.sleep(10)
        response = requests.get(url, params=params)
    report = response.json()
    # print(report)
    if 'scans' in report:
        if 'Kaspersky' in report['scans']:
            print(report['scans']['Kaspersky']['result'])
            label = report['scans']['Kaspersky']['result']
            if not label is None:
                label = label.split('.')[0]
                label = label.split(':')[-1]
            print(md5, label)
            return label


DIR = 'E:/malware_part2_unzip_rename_tmp'
SAVE_DIR = './result_total.json'
fopen = open('result_ly.json','r')
dict = eval(fopen.read())

fopen2 = open('result_das.json','r')
dict2 = eval(fopen2.read())


files = os.listdir(DIR)
print(files)
for file in files:
    md5 = file.split('.')[0]
    print(md5)
    if (md5 in dict2) and (not md5 in dict):
        dict[md5] = {}
        dict[md5]['label'] = dict2[md5]['label']
    elif (not md5 in dict2):
        label = get_label(md5)
        dict[md5] = {}
        dict[md5]['label'] = label

fwrite = open(SAVE_DIR, 'w')
fwrite.write(str(dict))
fwrite.close()
