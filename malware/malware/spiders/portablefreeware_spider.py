# scrapy benign
# scrapy crawl completelyfreesoftware
import scrapy
from scrapy.selector import Selector
import re
import subprocess
# from malware.items import FileDownloadItem


FILE_STORE='F:/benignware/'
CATAGORY = 'we'

class PortablefreewareSpider(scrapy.Spider):
    name = "completelyfreesoftware"
    allowed_domains = ["completelyfreesoftware.com"]
    start_urls = ["https://www.completelyfreesoftware.com/"+ CATAGORY + "1_w95.html"]
    res = []

    def parse(self, response):
        # print(response.body)
        sel = Selector(text=response.body,type="html")
        links = sel.xpath("//tr/td/a/@href").re('.*\.exe')
        for link in links:
            print(link)
            p = subprocess.Popen(["wget", link, "-P", FILE_STORE],shell=True)
            p.wait()
        # item = FileDownloadItem()
            # item['file_urls'] = self.res
        # yield item
        if response.url.find(CATAGORY) == -1:
            return
        else:
            nextpage = int(re.findall(CATAGORY + '(\d{1,2})_w95', response.url)[0]) + 1
            if nextpage < 19:
                yield scrapy.Request(url=re.sub(CATAGORY + '(\d{1,2})_w95', CATAGORY + str(nextpage) + '_w95', response.url),
                                     callback=self.parse)

