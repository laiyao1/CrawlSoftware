import os
import requests
import time

FILE_DIR = 'G:/unzip_dasmalwerk_md5/'
SAVE_DIR = 'G:/unzip_dasmalwerk_md5_group/'
files = os.listdir(FILE_DIR)
print(files)

requests.adapters.DEFAULT_RETRIES = 5
url = 'https://www.virustotal.com/vtapi/v2/file/report'
params = {'apikey': 'b1571259fa877a755620a3cacb5833622fcdd8695a81be93306a747c408795e7',
          'resource': '<resource>'}

output = {}

if os.path.exists('result_das.json'):
    fopen = open('result_das.json','r')
    output = eval(fopen.read())
    fopen.close()

for idx,file in enumerate(files):
    md5_tmp = file.split('.')[0]
    md5 = md5_tmp.split('_')[1]
    print('md5', md5)
    if md5 in output:
        print('pass')
        continue
    params['resource'] = md5
    response = requests.get(url, params=params)
    while response.status_code != 200:
        time.sleep(3)
        response = requests.get(url, params=params)
    report = response.json()
    # print(report)
    if 'scans' in report:
        if 'Kaspersky' in report['scans']:
            print(report['scans']['Kaspersky']['result'])
            label = report['scans']['Kaspersky']['result']
            if not label is None:
                label = label.split('.')[0]
                label = label.split(':')[-1]
                # label = label.split('-')[0]
            print(label)
            output[md5] = {}
            output[md5]['label'] = label
            # output[md5]['dir'] = dir

    if idx % 10 == 0:
        fwrite = open('result_das.json', 'w')
        fwrite.write(str(output))
        fwrite.close()

print(output)
