import os
import json
import requests
import time

PATH = 'F:/07_09&11_18/analyses'

dirs = os.listdir(PATH)
print(dirs)

requests.adapters.DEFAULT_RETRIES = 5
url = 'https://www.virustotal.com/vtapi/v2/file/report'
params = {'apikey': 'b1571259fa877a755620a3cacb5833622fcdd8695a81be93306a747c408795e7',
          'resource': '<resource>'}

output = {}

fopen = open('result2.json','r')
output = eval(fopen.read())
fopen.close()


for i, dir in enumerate(dirs):
    print(str(i)+ '/'+str(len(dirs)))
    if os.path.isdir(os.path.join(PATH, dir)):
        fopen = open(os.path.join(PATH, dir, 'task.json'),'r')
        new_dict = json.load(fopen)
        target = new_dict['target']
        md5 = target.split('/')[-1]
        print(md5)
        if output.has_key(md5):
            print('pass')
            continue
        params['resource'] = md5
        response = requests.get(url, params=params)
        while response.status_code != 200:
            time.sleep(3)
            response = requests.get(url, params=params)
        report = response.json()
        # print(report)
        if report.has_key('scans'):
            if report['scans'].has_key('Kaspersky'):
                print(report['scans']['Kaspersky']['result'])
                label = report['scans']['Kaspersky']['result']
                if not label is None:
                    label = label.split('.')[0]
                    label = label.split(':')[-1]
                    # label = label.split('-')[0]
                print(label)
                output[md5] = {}
                output[md5]['label'] = label
                output[md5]['dir'] = dir

        if i%10 == 0:
            fwrite = open('result2.json','w')
            fwrite.write(str(output))
            fwrite.close()




